## 项目简介

本项目是一个用于数据库之间数据同步的工具(单向)，支持从源数据库到目标数据库的批量数据同步。该工具可以用于数据备份、数据迁移以及数据一致性维护等场景。通过配置不同的表对，用户可以灵活地选择需要同步的数据。

## 核心功能

- **支持多表同步**：用户可以配置多个表对进行同步。
- **增量同步**：支持基于更新时间的增量同步，避免全量同步带来的性能开销。
- **错误重试机制**：在同步过程中，如果发生错误，系统会自动重试，确保数据的可靠性。
- **日志记录**：同步过程中的重要事件（如开始、完成、错误）会被记录，方便后续的监控和排查。

## 数据同步流程

1. **加载配置**：程序启动时加载配置文件，获取源数据库和目标数据库的连接信息、同步表对及其他参数。
2. **初始化数据库连接**：根据配置文件中的信息，初始化源数据库和目标数据库的连接。
3. **任务注册**：根据配置的表对，注册同步任务。
4. **开始同步**：
   - 遍历所有注册的同步任务。
   - 对于每个任务，首先检查是否需要同步（通过校验和或更新时间）。
   - 如果需要同步，获取源表的数据，并根据配置的批量大小进行分批处理。
   - 将数据插入到目标表中，并在目标表中清理不存在于源表的记录。
5. **完成同步**：同步完成后，记录同步状态，并通知观察者。

## 原理

- **数据库连接**：使用 GORM 作为 ORM 框架，简化数据库操作。
- **批量处理**：通过设置批量大小，减少数据库交互次数，提高同步效率。
- **重试机制**：在执行 SQL 语句时，如果发生错误，系统会根据设定的重试次数和延迟时间进行重试，确保数据同步的成功率。


## check_method的三种用法

在配置文件中，每个表对可以设置`check_method`参数，用于决定如何检查源表和目标表是否需要同步。该项目支持三种检查方法：

### 1. checksum（默认方法）

```yaml
check_method: "checksum"
```

**工作原理**：使用MySQL的`CHECKSUM TABLE`命令计算源表和目标表的校验和，如果校验和不一致，则认为需要同步。

**优势**：
- 精确性高，能够检测到任何数据差异
- 不需要特定的字段支持

**劣势**：
- 对大表性能影响较大，计算校验和需要扫描整个表
- 资源消耗较高

### 2. count

```yaml
check_method: "count"
```

**工作原理**：比较源表和目标表的记录数，如果记录数不一致，则认为需要同步。

**优势**：
- 性能开销小，只需要执行COUNT查询
- 速度快，适合大表的快速检查

**劣势**：
- 精确性低，无法检测到记录数相同但内容不同的情况
- 可能导致数据不一致问题被忽略

### 3. update_time

```yaml
check_method: "update_time"
update_field: "update_time"  # 必须指定更新时间字段
```

**工作原理**：比较源表和目标表中最新记录的更新时间字段，如果时间不一致，则认为需要同步。

**优势**：
- 性能较好，只需要查询最新的一条记录
- 适合频繁更新的表，可以快速检测到变化

**劣势**：
- 要求表中必须有更新时间字段
- 如果只是修改了旧记录而没有新增记录，可能检测不到变化
- 依赖于数据库时间字段的准确性和一致性

## sync_mode的作用

在配置文件中，`sync_mode`参数控制同步的方式，有两种可选值：

```yaml
sync_mode: "full"  # 可选值: "full" 或 "incremental"
```

### 1. full（全量同步）

**工作原理**：每次同步时，会获取源表的所有数据，并与目标表进行比对和更新。

**适用场景**：
- 初始数据迁移
- 数据量较小的表
- 需要确保完全一致性的场景

### 2. incremental（增量同步）

**工作原理**：只同步自上次同步以来发生变化的数据，通常依赖于更新时间字段或其他标识变化的机制。

**适用场景**：
- 数据量大且变化频繁的表
- 网络带宽或资源有限的环境
- 实时性要求较高的场景

## 总结

这个MySQL同步工具通过灵活的配置，提供了多种同步策略和检查方法，可以根据不同的业务需求和数据特性选择最合适的同步方式。在选择`check_method`时，需要权衡性能和精确性；在选择`sync_mode`时，需要考虑数据量大小和变化频率。
        

## 使用步骤

1. **配置文件**：在 `configs/config.yml` 中配置源数据库和目标数据库的连接信息，以及需要同步的表对
2. **构建项目**：使用 Docker 构建项目镜像，并上创到私有仓库harbor
   ```bash
   docker build -t repo/sync:latest .
   ```
3. **构建项目**：两服务器都要安装同步依赖，先将数据做全量同步
   ```bash
   apt-get update
   sudo apt-get install -y mysql-client sshpass vim
   ./migrate_mysql.sh   ## 根据具体情况来更新编辑里面的变量
   ```
4. **运行项目**：启动 Docker 容器，运行同步工具,如果是k8s部署,看haios-ustgz-addsync.yml
   ```bash
   docker run -d -p 28081:28081 repo/sync:latest
   ```




